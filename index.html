<!DOCTYPE html>
<html>
<head>
  <title>NSE Stock Tracker with 52-Week Range</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --up-color: #0d9e0d;
      --down-color: #e53935;
      --neutral-color: #7f8c8d;
      --range-bg: #f0f0f0;
    }
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f8f9fa;
    }
    .header {
      position: sticky;
      top: 0;
      background: white;
      padding: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 100;
    }
    h1 {
      margin: 0;
      color: #2c3e50;
      font-size: 1.5rem;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    #search {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .last-updated {
      color: var(--neutral-color);
      font-size: 0.8rem;
      text-align: right;
      margin-top: 5px;
    }
    .stocks-container {
      margin-top: 15px;
    }
    .stock {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: white;
      margin-bottom: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .stock-info {
      flex: 1;
    }
    .stock-name {
      font-weight: 500;
      color: #2c3e50;
    }
    .stock-symbol {
      font-size: 0.8rem;
      color: var(--neutral-color);
      margin-top: 2px;
    }
    .price-data {
      text-align: right;
      margin-left: 15px;
    }
    .current-price {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .price-up {
      color: var(--up-color);
    }
    .price-down {
      color: var(--down-color);
    }
    .price-change {
      font-size: 0.85rem;
      margin-top: 3px;
    }
    .week-range {
      display: flex;
      align-items: center;
      margin-top: 5px;
      font-size: 0.8rem;
    }
    .range-bar {
      flex: 1;
      height: 6px;
      background: var(--range-bg);
      border-radius: 3px;
      margin: 0 8px;
      position: relative;
      overflow: hidden;
    }
    .range-progress {
      position: absolute;
      height: 100%;
      background: linear-gradient(90deg, var(--down-color), var(--up-color));
    }
    .range-value {
      min-width: 40px;
      text-align: center;
    }
    .loading {
      opacity: 0.6;
    }
    .error {
      color: var(--down-color);
    }
    .refresh-btn {
      background: #2c3e50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .stock {
        flex-direction: column;
        align-items: flex-start;
      }
      .price-data {
        width: 100%;
        text-align: left;
        margin-top: 8px;
        margin-left: 0;
        border-top: 1px solid #eee;
        padding-top: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>NSE Stocks with 52-Week Range</h1>
    <div class="controls">
      <input type="text" id="search" placeholder="Search stocks...">
      <button class="refresh-btn" id="refreshBtn">Refresh</button>
    </div>
    <div class="last-updated" id="lastUpdated"></div>
  </div>
  <div class="stocks-container" id="stocksContainer"></div>

  <script>
    // Nifty 50 stocks (expandable to 100+)
    const symbols = [
      'RELIANCE', 'TCS', 'HDFCBANK', 'INFY', 'HINDUNILVR', 
      'ICICIBANK', 'KOTAKBANK', 'BHARTIARTL', 'LT', 'ITC',
      'SBIN', 'BAJFINANCE', 'HCLTECH', 'ASIANPAINT', 'MARUTI',
      'TITAN', 'SUNPHARMA', 'AXISBANK', 'NESTLEIND', 'ULTRACEMCO',
      'WIPRO', 'ONGC', 'JSWSTEEL', 'TATASTEEL', 'POWERGRID',
      'NTPC', 'INDUSINDBK', 'COALINDIA', 'BPCL', 'IOC',
      'GRASIM', 'HDFCLIFE', 'DRREDDY', 'SHREECEM', 'UPL',
      'BAJAJFINSV', 'ADANIPORTS', 'TECHM', 'HEROMOTOCO', 'DIVISLAB',
      'CIPLA', 'EICHERMOT', 'BRITANNIA', 'VEDL', 'HDFC',
      'SBILIFE', 'GAIL', 'BAJAJ-AUTO', 'TATAMOTORS', 'M&M'
    ];

    // Configuration
    const config = {
      batchSize: 10,
      delayBetweenBatches: 1000,
      fullRefreshInterval: 300000 // 5 minutes
    };

    // State management
    const state = {
      stocksData: {},
      visibleStocks: [],
      currentBatch: 0,
      isFetching: false,
      lastUpdated: null
    };

    // DOM elements
    const elements = {
      container: document.getElementById('stocksContainer'),
      search: document.getElementById('search'),
      refreshBtn: document.getElementById('refreshBtn'),
      lastUpdated: document.getElementById('lastUpdated')
    };

    // Initialize
    init();

    function init() {
      loadFromCache();
      attachEventListeners();
      fetchNextBatch();
      startAutoRefresh();
    }

    function attachEventListeners() {
      elements.search.addEventListener('input', filterStocks);
      elements.refreshBtn.addEventListener('click', manualRefresh);
    }

    // Formatting functions
    function formatPrice(price) {
      return price ? '₹' + price.toFixed(2) : '₹--';
    }

    function formatChange(change, percent) {
      if (change === undefined || percent === undefined) return '';
      const sign = change >= 0 ? '+' : '';
      return `${sign}${change.toFixed(2)} (${sign}${percent.toFixed(2)}%)`;
    }

    function getChangeClass(change) {
      if (change === undefined || change === 0) return '';
      return change > 0 ? 'price-up' : 'price-down';
    }

    function calculateRangePosition(current, low, high) {
      if (!current || !low || !high) return 50;
      const range = high - low;
      const position = ((current - low) / range) * 100;
      return Math.min(100, Math.max(0, position));
    }

    // Data fetching
    async function fetchStockData(symbol) {
      try {
        // Using proxy to avoid CORS (replace with your backend in production)
        const proxyUrl = 'https://api.allorigins.win/get?url=';
        const nseUrl = encodeURIComponent(
          `https://www.nseindia.com/api/quote-equity?symbol=${symbol}`
        );
        
        const response = await fetch(proxyUrl + nseUrl);
        if (!response.ok) throw new Error('Network error');
        
        const data = await response.json();
        const stockData = JSON.parse(data.contents);
        
        if (!stockData.priceInfo) throw new Error('No price data');
        
        const priceInfo = stockData.priceInfo;
        const lastPrice = priceInfo.lastPrice;
        const prevClose = priceInfo.previousClose;
        const change = lastPrice - prevClose;
        const changePercent = (change / prevClose) * 100;
        
        // 52-week range data
        const week52High = stockData.priceInfo?.high52Week || 0;
        const week52Low = stockData.priceInfo?.low52Week || 0;
        
        return {
          symbol,
          name: stockData.info?.companyName || symbol,
          price: lastPrice,
          change,
          changePercent,
          week52High,
          week52Low,
          timestamp: Date.now()
        };
      } catch (error) {
        console.error(`Error fetching ${symbol}:`, error);
        return {
          symbol,
          name: symbol,
          error: true,
          errorMessage: error.message
        };
      }
    }

    // Batch processing (same as before)
    async function fetchNextBatch() {
      if (state.isFetching) return;
      state.isFetching = true;
      
      const batchStart = state.currentBatch * config.batchSize;
      const batchEnd = batchStart + config.batchSize;
      const batchSymbols = symbols.slice(batchStart, batchEnd);
      
      if (batchSymbols.length === 0) {
        state.currentBatch = 0;
        state.isFetching = false;
        state.lastUpdated = Date.now();
        updateLastUpdatedDisplay();
        saveToCache();
        return;
      }

      try {
        const batchResults = await Promise.all(
          batchSymbols.map(symbol => fetchStockData(symbol))
        );

        batchResults.forEach(stock => {
          state.stocksData[stock.symbol] = stock;
        });

        filterStocks();
        
        state.currentBatch++;
        setTimeout(() => {
          state.isFetching = false;
          fetchNextBatch();
        }, config.delayBetweenBatches);
      } catch (error) {
        console.error('Batch error:', error);
        state.isFetching = false;
      }
    }

    // Enhanced UI rendering with 52-week range
    function renderStocks() {
      elements.container.innerHTML = state.visibleStocks
        .map(stock => {
          if (stock.error) {
            return `
              <div class="stock error">
                <div class="stock-info">
                  <div class="stock-name">${stock.name}</div>
                  <div class="stock-symbol">${stock.symbol}</div>
                </div>
                <div>Failed to load</div>
              </div>
            `;
          }
          
          const changeClass = getChangeClass(stock.change);
          const rangePosition = calculateRangePosition(
            stock.price, 
            stock.week52Low, 
            stock.week52High
          );
          
          return `
            <div class="stock">
              <div class="stock-info">
                <div class="stock-name">${stock.name}</div>
                <div class="stock-symbol">${stock.symbol}</div>
                
                <div class="week-range">
                  <span class="range-value">${formatPrice(stock.week52Low)}</span>
                  <div class="range-bar">
                    <div class="range-progress" style="width: ${rangePosition}%"></div>
                  </div>
                  <span class="range-value">${formatPrice(stock.week52High)}</span>
                </div>
              </div>
              
              <div class="price-data">
                <div class="current-price ${changeClass}">
                  ${formatPrice(stock.price)}
                </div>
                <div class="price-change ${changeClass}">
                  Today: ${formatChange(stock.change, stock.changePercent)}
                </div>
              </div>
            </div>
          `;
        })
        .join('');
    }

    // Rest of the code remains the same (filterStocks, updateLastUpdatedDisplay, 
    // saveToCache, loadFromCache, manualRefresh, startAutoRefresh)
    function filterStocks() {
      const searchTerm = elements.search.value.toLowerCase();
      state.visibleStocks = Object.values(state.stocksData)
        .filter(stock => 
          stock.symbol.toLowerCase().includes(searchTerm) || 
          (stock.name && stock.name.toLowerCase().includes(searchTerm))
        .sort((a, b) => a.symbol.localeCompare(b.symbol));
      
      renderStocks();
    }

    function updateLastUpdatedDisplay() {
      if (!state.lastUpdated) return;
      const date = new Date(state.lastUpdated);
      elements.lastUpdated.textContent = `Last updated: ${date.toLocaleTimeString()}`;
    }

    function saveToCache() {
      localStorage.setItem('nseStocksCache', JSON.stringify({
        data: state.stocksData,
        timestamp: Date.now()
      }));
    }

    function loadFromCache() {
      const cache = localStorage.getItem('nseStocksCache');
      if (!cache) return;
      
      try {
        const parsed = JSON.parse(cache);
        if (Date.now() - parsed.timestamp < 3600000) {
          state.stocksData = parsed.data;
          filterStocks();
        }
      } catch (e) {
        console.error('Cache load failed', e);
      }
    }

    function manualRefresh() {
      state.currentBatch = 0;
      fetchNextBatch();
    }

    function startAutoRefresh() {
      setInterval(() => {
        state.currentBatch = 0;
        fetchNextBatch();
      }, config.fullRefreshInterval);
    }
  </script>
</body>
</html>
